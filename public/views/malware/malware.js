/**
 * /public/views/malware/malware.js
 *
 * @description: Malware view
 * @author: Chris Young (young.c.5690@gmail.com)
 * @created: September 17th 2015
 */

var Request = require('../../utils/request.js');

var Malwares = require('../../collections/malwares.js');

module.exports = Backbone.View.extend({

  /**
   * Malware.initialize()
   * @description: Loads view template
   * @param: {Object} options
   */
  initialize: function (options) {
    var that = this;

    _.extend(this, options);

    this.malwares = new Malwares();

    this.errorTemplate = _.template(this.parent.ui.$errorTemplate.html());
    this.loadingTemplate = _.template(this.parent.ui.$loadingTemplate.html());

    new Request({
      url: 'views/malware/malware.tmpl',
      callback: function (error, body) {
        if (!error) {
          that.template = _.template(body);
        }

        that.render();
      }
    });
  },

  /**
   * Malware.setUiElements()
   * @description: Gets DOM references for view elements
   */
  setUiElements: function () {
    this.ui = {
      $malwarePageLoading: $('#malware-page-loading'),
      $tableWrapper: $('#malware-content div.table-wrapper'),
      $contentBox: $('#content div.box'),
      $sortLinks: $('#malware-content a.sort-link')
    };
  },

  /**
   * Malware.render()
   * @description: Draws the view
   */
  render: function () {
    var that = this;

    if (!this.template) {
      return this.$el.html(this.errorTemplate());
    }

    if (!this.malwares.length) {
      this.$el.html(this.loadingTemplate());
    } else {
      this.ui.$malwarePageLoading.removeClass('hidden');
    }

    this.malwares.on('error sync', function (event) {
      if (event.type === 'error') {
        return that.$el.html(that.errorTemplate());
      }

      that.$el.html(that.template({ malwares: that.malwares }));
      that.setUiElements();

      that.resize()
      $(window).resize(_.bind(that.resize, that));
    });

    this.malwares.fetch();
  },

  /**
   * events
   * @description: Declares view click events
   */
  events: {
    'click #malware-content a.sort-link': 'sort'
  },

  /**
   * Malware.resize()
   * @description: Resizes the table wrapper on window resize
   */
  resize: function () {
    this.ui.$tableWrapper.css('max-height', this.ui.$contentBox.height());
  },

  /**
   * Malware.sort()
   * @description: Reorders the collection based on sort method
   */
  sort: function (event) {
    var $target = $(event.target).parents('a.sort-link');

    event.preventDefault();

    this.malwares.sortMethod.key = $target.data('key');
    this.malwares.sortMethod.direction = $target.find('span.sort-icon').hasClass('fa-sort-down') ? 1 : -1;
    this.malwares.sort();

    this.render();
  }

});


require 'rails_helper'

Shoulda::Matchers.configure do |config|
  config.integrate do |with|
    # Choose a test framework:
    with.test_framework :rspec
    with.library :rails
  end
end

RSpec.describe MalwareFile, type: :model do
  it { should validate_presence_of(:md5) }
  it { should validate_presence_of(:classification_name) }
  it { should validate_presence_of(:classification_type) }
  it { should validate_presence_of(:size) }
  it { should validate_presence_of(:file_type) }

  describe '.import' do
    it 'should parse a csv and save information to the database' do
      file = File.new('spec/example_csvs/example_file.csv')
      MalwareFile.import(file)
      expect(MalwareFile.count).to eq(12)
      expect(MalwareFile.first.size).to eq(6604)
      expect(MalwareFile.last.file_type).to eq('unknown')
    end
  end

  describe '.camel_case?' do
    it 'should tell if a string has camel case' do
      string = 'HelloThere'
      expect(MalwareFile.camel_case?(string)).to be true
      string = "AK47"
      expect(MalwareFile.camel_case?(string)).to be false
    end
  end

  describe '.camel_case_to_snake_case' do
    it 'should convert camel case to snake case' do
      string = 'CamelGoesSpitSpit'
      expect(MalwareFile.camel_case_to_snake_case(string)).to eq('camel_goes_spit_spit')
    end
  end

  describe '.group_and_count_by_classifcation_type' do
    it 'should count the different types of classification type' do
      MalwareFile.create(
                         md5: '09134ukzxjkjsjef',
                         classification_name: 'downloader',
                         classification_type: 'unknown',
                         size: 49284,
                         file_type: 'exe'

                        )
      MalwareFile.create(
                         md5: '09134ukzxjkj34sjef',
                         classification_name: 'downloader',
                         classification_type: 'trojan',
                         size: 49284,
                         file_type: 'exe'

                        )
      MalwareFile.create(
                         md5: '09134ukzxjkjsjaf',
                         classification_name: 'downloader',
                         classification_type: 'unknown',
                         size: 49284,
                         file_type: 'exe'

                        )

      expect(MalwareFile.group_and_count_by_classifcation_type).to eq('trojan' => 1, 'unknown' => 2)
    end
  end
end

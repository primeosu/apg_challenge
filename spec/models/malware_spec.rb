require 'rails_helper'

RSpec.describe Malware, type: :model do

  describe 'validations' do

    before(:each) { @malware = build(:malware) }

    it 'has a valid factory' do
      expect(@malware).to be_valid
    end

    describe 'invalid states' do

      after(:each) { expect(@malware).not_to be_valid }

      it 'is invalid when md5 is nil' do
        @malware.md5 = nil
      end

      it 'is invalid when md5 is not an MD5 hash' do
        @malware.md5 = 'Nope. Not a hash'
      end

      it 'is invalid when md5 is not in hex format' do
        @malware.md5 = '0xH41D8CD98F00B204E9800998ECF8427E'
      end

      it 'is invalid when md5 is missing the hex string prefix' do
        @malware.md5 = 'A41D8CD98F00B204E9800998ECF8427E'
      end

      it 'is invalid when md5 is not unique' do
        create(:malware)
      end

      it 'is invalid when size is nil' do
        @malware.size = nil
      end
    end
  end

  describe '.import' do

    # note - without testing the contents of the input file, changing it
    #        runs the risk of inadvertantly creating invalid input.
    #        Keep that in mind if all the tests in this section suddenly fail
    before(:each) do
      filepath = File.expand_path '../../../example_input.csv', __FILE__
      data = double('just a stub')
      allow(data).to receive(:path).and_return(filepath)
      allow(data).to receive(:content_type).and_return('text/csv')
      Malware.import(data)
    end

    it 'can create records from a valid csv file' do
      expect(Malware.all.length).to be > 0
    end

    it 'creates associated models and assigns them' do
      malware = Malware.all
      malware.each do |mal|
        expect(mal.filetype).not_to be_nil
        expect(mal.classification).not_to be_nil
      end
    end
  end

  describe '.create_from_csv_row!' do
    describe 'happy paths' do
      before(:each) do
        row = {
          'ClassificationName' => 'Barney',
          'ClassificationType' => 'Purple dinosaur',
          'FileType'           => 'prp',
          'Size'               => 1,
          'MD5'                => '0xA41D8CD98F00B204E9800998ECF8427E'
        }
        Malware.create_from_csv_row!(row)
      end

      it 'creates a malware entry from hash data' do
        expect(Malware.count).to eq(1)
      end

      it 'creates associations for the malware' do
        malware = Malware.first
        expect(malware.filetype).to eq(Filetype.first)
        expect(malware.classification).to eq(Classification.first)
      end
    end

    it 'throws an error when invalid data is passed in' do
      garbage_in = 'Im not really a hash'
      expect{ Malware.create_from_csv_row garbage_in }.to raise_error(NameError)
    end
  end

  describe 'threat_type counting methods' do
    before (:each) do
      create(:malware, :random_md5)
      a_bug = create(:classification, threat_type: 'bug')
      2.times { create(:malware, :random_md5, classification: a_bug) }
    end

    describe '.threat_count' do
      it 'returns a collection of threat types and counts' do
        expect(Malware.threat_count).to include('bug' => 2, 'worm' => 1)
      end
    end

    describe '.threat_table' do
      it 'massages threat_count output with attribute names' do
        table_data = Malware.threat_table
        expect(table_data[0].values).to include('bug', 2)
        expect(table_data[1].values).to include('worm', 1)
      end
    end
  end

end
